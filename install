#!/bin/bash

set -e  # Exit on error

echo "Installing dotfiles..."

# Get the directory where this script is located
DOTFILES_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Detect OS
OS=$(uname)
echo "Detected OS: $OS"

# Install oh-my-zsh if not already installed
if [ ! -d "$HOME/.oh-my-zsh" ]; then
  echo "Installing oh-my-zsh..."
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  echo "oh-my-zsh installed"
else
  echo "oh-my-zsh already installed"
fi

# Set zsh as default shell if not already set
if [ "$SHELL" != "$(which zsh)" ]; then
  echo "Setting zsh as default shell..."
  if chsh -s "$(which zsh)" 2>/dev/null; then
    echo "zsh set as default shell"
  else
    echo "Could not change shell automatically. Run manually: chsh -s $(which zsh)"
  fi
else
  echo "zsh is already the default shell"
fi

# OS-specific package installation
if [ "$OS" = "Darwin" ]; then
  echo "Installing brew dependencies..."
  brew install vim
  brew install fzf
  brew install ripgrep
  brew install zellij
  brew install eza
  brew install lazygit
  brew install zsh-autosuggestions
  brew install bat
  echo "brew dependencies installed"

  # Install Fira Code font
  if ! brew list --cask font-fira-code &>/dev/null; then
    echo "Installing Fira Code font..."
    brew install --cask font-fira-code
  else
    echo "Fira Code font already installed"
  fi

elif [ "$OS" = "Linux" ]; then
  echo "Installing apt dependencies..."
  sudo apt update
  sudo apt install -y vim fzf ripgrep bat zsh fonts-firacode

  # eza: add gierens PPA
  if ! command -v eza &>/dev/null; then
    echo "Installing eza..."
    sudo mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
    echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
    sudo apt update
    sudo apt install -y eza
  else
    echo "eza already installed"
  fi

  # lazygit: add PPA
  if ! command -v lazygit &>/dev/null; then
    echo "Installing lazygit..."
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -Lo /tmp/lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
    sudo tar xf /tmp/lazygit.tar.gz -C /usr/local/bin lazygit
    rm /tmp/lazygit.tar.gz
  else
    echo "lazygit already installed"
  fi

  # zellij: download binary from GitHub releases
  if ! command -v zellij &>/dev/null; then
    echo "Installing zellij..."
    ZELLIJ_VERSION=$(curl -s "https://api.github.com/repos/zellij-org/zellij/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -Lo /tmp/zellij.tar.gz "https://github.com/zellij-org/zellij/releases/latest/download/zellij-x86_64-unknown-linux-musl.tar.gz"
    sudo tar xf /tmp/zellij.tar.gz -C /usr/local/bin
    sudo chmod +x /usr/local/bin/zellij
    rm /tmp/zellij.tar.gz
  else
    echo "zellij already installed"
  fi

  # zsh-autosuggestions
  sudo apt install -y zsh-autosuggestions

  echo "apt dependencies installed"
else
  echo "Unsupported OS: $OS"
  exit 1
fi

# Symlink dotfiles
echo "Symlinking dotfiles..."
ln -nsf "$DOTFILES_DIR/.zshrc" ~/.zshrc
ln -nsf "$DOTFILES_DIR/.vimrc" ~/.vimrc
ln -nsf "$DOTFILES_DIR/.gitconfig" ~/.gitconfig

# Symlink zellij config directory
mkdir -p ~/.config
ln -nsf "$DOTFILES_DIR/.config/zellij" ~/.config/zellij

# Symlink lazygit config directory
ln -nsf "$DOTFILES_DIR/.config/lazygit" ~/.config/lazygit

echo "dotfiles symlinked"

# Install vim-plug for vim
if [ ! -f ~/.vim/autoload/plug.vim ]; then
  echo "Installing vim-plug..."
  curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  echo "vim-plug installed"
else
  echo "vim-plug already installed"
fi

# Install vim plugins
echo "Installing vim plugins..."
vim +PlugInstall! +qall

echo ""
echo "Installation complete!"
